"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9461],{5612:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>r,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"tutorials/tutorial-basics/app-plane-utils","title":"Application plane utilities","description":"Although entirely optional, SBT includes a utility that lets you define, and run arbitrary jobs upon receipt of a control plane message, called a ScriptJob. This mechanism is extended to produce two new helper constructs ProvisioningScriptJob and DeprovisioningScriptJob which are used for onboarding and off-boarding, respectively, in the reference architectures which were ported to SBT (see references at the end of this document). That tenant provisioning/deprovisioning process is depicted below:","source":"@site/docs/tutorials/tutorial-basics/app-plane-utils.md","sourceDirName":"tutorials/tutorial-basics","slug":"/tutorials/tutorial-basics/app-plane-utils","permalink":"/sbt-aws/docs/tutorials/tutorial-basics/app-plane-utils","draft":false,"unlisted":false,"editUrl":"https://github.com/awslabs/sbt-aws/blob/main/website/docs/tutorials/tutorial-basics/app-plane-utils.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"tutorialSidebar","previous":{"title":"Create the application plane","permalink":"/sbt-aws/docs/tutorials/tutorial-basics/create-application-plane"},"next":{"title":"Provisioning script breakdown","permalink":"/sbt-aws/docs/tutorials/tutorial-basics/provisioning-script-breakdown"}}');var s=n(4848),o=n(8453);const r={sidebar_position:6},a="Application plane utilities",c={},l=[];function d(e){const t={a:"a",code:"code",h1:"h1",header:"header",img:"img",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"application-plane-utilities",children:"Application plane utilities"})}),"\n",(0,s.jsxs)(t.p,{children:["Although entirely optional, SBT includes a utility that lets you define, and run arbitrary jobs upon receipt of a control plane message, called a ",(0,s.jsx)(t.code,{children:"ScriptJob"}),". This mechanism is extended to produce two new helper constructs ",(0,s.jsx)(t.code,{children:"ProvisioningScriptJob"})," and ",(0,s.jsx)(t.code,{children:"DeprovisioningScriptJob"})," which are used for onboarding and off-boarding, respectively, in the reference architectures which were ported to SBT (see references at the end of this document). That tenant provisioning/deprovisioning process is depicted below:"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"sbt-provisioning.png",src:n(6718).A+"",width:"791",height:"581"})}),"\n",(0,s.jsxs)(t.p,{children:["Notice the use of the ",(0,s.jsx)(t.code,{children:"provisioning.sh"})," and ",(0,s.jsx)(t.code,{children:"deprovisioning.sh"})," scripts at the top. These scripts are fed to the ",(0,s.jsx)(t.code,{children:"ProvisioningScriptJob"})," and ",(0,s.jsx)(t.code,{children:"DeprovisioningScriptJob"})," as parameters. Internally the ",(0,s.jsx)(t.code,{children:"ScriptJob"})," launches an AWS ",(0,s.jsx)(t.code,{children:"CodeBuild"})," project, wrapped inside an AWS Step Function, to execute the bash scripts. The ",(0,s.jsx)(t.code,{children:"ScriptJob"})," also lets you specify what input variables to feed to the scripts, along with what output variables you expect them to return. Note that in this version of SBT, you can create the ",(0,s.jsx)(t.code,{children:"ScriptJob"})," construct with ",(0,s.jsx)(t.code,{children:"ScriptJobProps"})," and configure ",(0,s.jsx)(t.code,{children:"CoreAppPlane"})," with ",(0,s.jsx)(t.code,{children:"ScriptJobs"})," using its ",(0,s.jsx)(t.code,{children:"scriptJobs"})," property. The ",(0,s.jsx)(t.code,{children:"CoreAppPlane"})," will then link these ",(0,s.jsx)(t.code,{children:"ScriptJobs"})," to EventBridge. Let's take a simple example: imagine our SaaS application deployed only a single S3 bucket per tenant. Let's create a ",(0,s.jsx)(t.code,{children:"ProvisioningScriptJob"})," for that provisioning now:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:"const scriptJobProps: TenantLifecycleScriptJobProps = {\n  permissions: PolicyDocument.fromJson(/*See below*/),\n  script: '' /*See below*/,\n  environmentStringVariablesFromIncomingEvent: ['tenantId', 'tier'],\n  environmentVariablesToOutgoingEvent: ['tenantS3Bucket', 'someOtherVariable', 'tenantConfig'],\n  scriptEnvironmentVariables: {\n    TEST: 'test',\n  },\n  eventManager: eventManager /*See below on how to create EventManager*/,\n};\n"})}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Key"}),(0,s.jsx)(t.th,{children:"Type"}),(0,s.jsx)(t.th,{children:"Purpose"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:"script"})}),(0,s.jsx)(t.td,{children:"string"}),(0,s.jsx)(t.td,{children:"A string in bash script format that represents the job to be run (example below)"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:"permissions"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_iam.PolicyDocument.html",children:"PolicyDocument"})}),(0,s.jsx)(t.td,{children:"An IAM policy document giving this job the IAM permissions it needs to do what it's being asked to do"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:"environmentStringVariablesFromIncomingEvent"})}),(0,s.jsx)(t.td,{children:"string[]"}),(0,s.jsx)(t.td,{children:"The environment variables to import into the ScriptJob from event details field."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:"environmentVariablesToOutgoingEvent"})}),(0,s.jsx)(t.td,{children:"string[]"}),(0,s.jsx)(t.td,{children:"The environment variables to export into the outgoing event once the ScriptJob has finished."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:"scriptEnvironmentVariables"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"{ [key: string]: string }"})}),(0,s.jsx)(t.td,{children:"The variables to pass into the codebuild ScriptJob."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.strong,{children:"eventManager"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.a,{href:"https://github.com/awslabs/sbt-aws/blob/main/API.md#eventmanager-",children:"IEventManager"})}),(0,s.jsx)(t.td,{children:"The EventManager instance that allows connecting to events flowing between the Control Plane and other components."})]})]})]}),"\n",(0,s.jsxs)(t.p,{children:["The heavy lifting of the ",(0,s.jsx)(t.code,{children:"ScriptJob"})," construct (along with constructs that extend it like ",(0,s.jsx)(t.code,{children:"ProvisioningScriptJob"}),") happens with the value of the script key. Let's take a look at the example provisioning script now:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:'echo "starting..."\n\n# note that this template.json is being created here, but\n# it could just as easily be pulled in from an S3 bucket.\ncat > template.json << EOM\n{\n  "AWSTemplateFormatVersion": "2010-09-09",\n  "Resources": {"MyBucket": {"Type": "AWS::S3::Bucket"}},\n  "Outputs": {"S3Bucket": {"Value": { "Ref": "MyBucket" }}}\n}\nEOM\n\necho "tenantId: $tenantId"\necho "tier: $tier"\n\naws cloudformation create-stack --stack-name "tenantTemplateStack-\\${tenantId}"  --template-body "file://template.json"\n\naws cloudformation wait stack-create-complete --stack-name "tenantTemplateStack-\\${tenantId}"\n\nexport tenantS3Bucket=$(aws cloudformation describe-stacks --stack-name "tenantTemplateStack-\\${tenantId}" | jq -r \'.Stacks[0].Outputs[0].OutputValue\')\nexport someOtherVariable="this is a test"\necho $tenantS3Bucket\nexport tenantConfig=$(jq --arg SAAS_APP_USERPOOL_ID "MY_SAAS_APP_USERPOOL_ID" \\\n--arg SAAS_APP_CLIENT_ID "MY_SAAS_APP_CLIENT_ID" \\\n--arg API_GATEWAY_URL "MY_API_GATEWAY_URL" \\\n-n \'{"userPoolId":$SAAS_APP_USERPOOL_ID,"appClientId":$SAAS_APP_CLIENT_ID,"apiGatewayUrl":$API_GATEWAY_URL}\')\n\necho $tenantConfig\nexport tenantStatus="created"\n\necho "done!"\n'})})]})}function p(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},6718:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/sbt-provisioning-ac11ea3395261eacd6c7d1478ada278c.png"},8453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>a});var i=n(6540);const s={},o=i.createContext(s);function r(e){const t=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(o.Provider,{value:t},e.children)}}}]);